<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>è¡¨æƒ…è¯†åˆ«æƒ…ç»ªå°æ¸¸æˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5a6f6;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #111827;
            --dark-blue: #1E293B;
            --light: #F3F4F6;
            --gray: #6B7280;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            overflow: hidden; /* Prevent page scroll */
        }

        body { 
            background: linear-gradient(135deg, var(--dark-blue), var(--dark)); 
            color: var(--light); 
        }
        
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 0 2vw 1vh 2vw; /* Removed top padding */
        }
        
        header {
            text-align: center;
            flex-shrink: 0;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('images/station1.png') center/cover no-repeat;
            opacity: 0.1;
            z-index: -1;
        }
        
        h1 { 
            font-size: 1.4rem; /* Reduced font size */
            font-weight: 700;
            color: var(--primary); 
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 0.8rem;
            color: var(--light);
            margin: 0 0 5px 0; /* Removed top margin */
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--light);
            cursor: pointer;
            padding: 5px;
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .icon-btn:hover {
            color: var(--primary);
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }

        .modal-content {
            background-color: var(--dark-blue);
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid var(--primary);
            border-radius: 15px;
            width: 80%; 
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .close-btn {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--light);
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-light);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--gray);
            background-color: var(--dark);
            color: var(--light);
            font-size: 1rem;
        }
        
        .container {
            display: flex;
            flex: 1;
            gap: 2vw;
            padding: 0 1.5vw 1.5vh 1.5vw; /* Removed top padding */
            min-height: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px; /* Further reduced margin */
        }
        
        button { 
            background: var(--primary); 
            color: var(--light); 
            border: none; 
            border-radius: 10px; 
            padding: 8px 16px; 
            font-size: 1rem; 
            font-weight: 600;
            cursor: pointer; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover { 
            background: var(--primary-dark); 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); 
        }
        
        button:disabled { 
            background: var(--primary-light); 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        #start-btn::before {
            content: 'â–¶';
        }
        
        #challenge-btn::before {
            content: 'ğŸ†';
        }

        #stop-btn {
            background: var(--danger);
        }

        #stop-btn:hover {
            background: #B91C1C;
        }

        #stop-btn::before {
            content: 'â¹';
        }
        
        .left-column {
            flex: 1; /* Equal width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align to top */
            min-width: 0;
        }

        .right-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1vh; /* Tighter gap */
            min-width: 0;
            min-height: 0; /* Crucial for flex shrinking */
        }



        .info-panel {
            flex: 1; /* Grow to fill available space */
            min-height: 0; /* Allow shrinking */
            overflow-y: auto;
            background: rgba(17, 24, 39, 0.7);
            border-radius: 15px;
            padding: 1vh 1.2vw; /* Tighter padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .xiaoai-section {
            flex: 0 0 auto; /* Don't grow, don't shrink, base on content */
            background: rgba(17, 24, 39, 0.7);
            border-radius: 15px;
            padding: 0.5vh 1.2vw; /* Tighter padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .game-instructions {
            flex: 0 0 auto; /* Don't grow, don't shrink, base on content */
            overflow-y: auto;
            background: rgba(17, 24, 39, 0.7);
            border-radius: 15px;
            padding: 1vh 1.2vw; /* Tighter padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .game-instructions h4 {
            margin-bottom: 5px;
        }

        .game-instructions p {
            margin-bottom: 5px;
        }
        

        
        #webcam-container {
            width: 100%;
            aspect-ratio: 4 / 3; /* More common aspect ratio */
            max-height: 75vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 3px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            background: rgba(17, 24, 39, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #webcam-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #webcam-container:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.5);
        }
        
        

        .emotion-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 3px; /* More compact margin */
            padding: 8px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
        }

        .emotion-name {
            width: 80px;
            font-weight: 500;
        }

        .emotion-progress {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .emotion-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .emotion-percentage {
            width: 60px;
            text-align: right;
            font-size: 0.9rem;
            color: var(--light);
        }

        #result {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: 500;
        }

        #emoji {
            font-size: 2rem;
            text-align: center;
            margin: 10px 0;
        }

        #score {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            margin: 10px 0;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        #challenge {
            margin-top: 10px;
            text-align: center;
        }

        .bonus-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        
        #label-container { 
            font-size: 1rem; 
            margin-bottom: 5px; /* More compact margin */
        }
        
        .emotion-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .emotion-name {
            width: 80px;
            text-align: left;
            font-weight: 500;
        }
        
        .emotion-progress {
            flex-grow: 1;
            height: 10px;
            background: rgba(107, 114, 128, 0.3);
            border-radius: 5px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .emotion-progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .emotion-percentage {
            width: 60px;
            text-align: right;
            font-weight: 600;
        }
        
        #result { 
            font-size: 1.2rem; 
            font-weight: bold; 
            margin: 1px 0; /* More compact margin */
            color: var(--primary); 
            min-height: 28px;
            line-height: 1.2;
        }
        
        #emoji { 
            font-size: 3rem; 
            margin: 1px 0; /* More compact margin */
            min-height: 40px; /* Compact height */
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #score { 
            font-size: 1.1rem; 
            font-weight: 600;
            color: var(--secondary);
            margin: 1px 0; /* More compact margin */
            line-height: 1.2;
        }
        
        .progress-container { 
            width: 100%; 
            background-color: rgba(107, 114, 128, 0.3); 
            border-radius: 6px; 
            margin: 3px 0; /* More compact margin */
            overflow: hidden;
        }
        
        .progress-bar { 
            height: 8px; 
            border-radius: 6px; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            transition: width 0.3s ease; 
        }
        
        #challenge { 
            font-size: 1.2rem; 
            margin: 1px 0; /* More compact margin */
            min-height: 28px;
            line-height: 1.2;
        }
        

        
        .xiaoai-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .xiaoai-image { 
            width: 80px;
            height: 80px;
            border-radius: 15px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }
        
        .xiaoai-image:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.5);
        }
        
        .speech-bubble { 
            background: white; 
            color: var(--dark); 
            padding: 10px 12px; 
            border-radius: 15px; 
            width: 90%;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }
        
        .speech-bubble:after { 
            content: ''; 
            position: absolute; 
            bottom: -15px; 
            left: 50%; 
            border-width: 15px 15px 0; 
            border-style: solid; 
            border-color: white transparent; 
        }
        
        .game-instructions h3 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .game-instructions ul {
            padding-left: 15px;
        }
        
        .game-instructions li {
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        
        .success-message {
            color: var(--secondary);
            font-weight: 600;
        }
        
        .fail-message {
            color: var(--danger);
            font-weight: 600;
        }
        
        .bonus-message {
            color: var(--warning);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header>
            <h1 style="font-size: 1.4rem; margin: 0;">è¡¨æƒ…è¯†åˆ«æƒ…ç»ªå°æ¸¸æˆ</h1>
            <p class="subtitle" style="font-size: 0.8rem; margin: 2px 0 5px 0;">å¯¹ç€æ‘„åƒå¤´åšå‡ºè¡¨æƒ…ï¼Œçœ‹çœ‹AIèƒ½ä¸èƒ½çŒœå‡ºä½ çš„æƒ…ç»ªï¼</p>
            
            <div class="button-group">
                <button type="button" onclick="init()" id="start-btn">å¼€å§‹æ¸¸æˆ</button>
                <button type="button" onclick="stopGame()" id="stop-btn" disabled>åœæ­¢æ¸¸æˆ</button>
                <button type="button" onclick="startChallenge()" id="challenge-btn" disabled>è¡¨æƒ…æŒ‘æˆ˜</button>
                <button type="button" id="settings-btn">âš™ï¸</button>
            </div>
        </header>

        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2>è®¾ç½®</h2>
                <div class="form-group">
                    <label for="api-url-input">AI æ¨¡å‹ API åœ°å€:</label>
                    <input type="text" id="api-url-input" placeholder="https://teachablemachine.withgoogle.com/models/your-model/">
                </div>
                <button id="save-settings-btn">ä¿å­˜</button>
            </div>
        </div>
        
        <div class="container">
            <div class="left-column">
                <div id="webcam-container"></div>
            </div>
            <div class="right-column">
                <div class="info-panel">
                    <div id="result"></div>
                    <div id="label-container"></div>
                    <div id="emoji"></div>
                    <div id="score">åˆ†æ•°: 0</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="challenge"></div>
                     <div id="bonus-toast" class="bonus-toast"></div>
                </div>
                <div class="xiaoai-section">
                    <div class="xiaoai-container">
                        <img src="images/xiaoai.png" alt="å°è‰¾" class="xiaoai-image" style="width: 100px; height: 100px;">
                        <div class="speech-bubble" id="xiaoai-speech">ä½ å¥½ï¼æˆ‘æ˜¯å°è‰¾ï¼Œæ¥å’Œæˆ‘ä¸€èµ·ç©è¡¨æƒ…æ¸¸æˆå§ï¼</div>
                    </div>
                </div>
                <div class="game-instructions">
                    <h3>æ¸¸æˆè¯´æ˜</h3>
                    <ul>
                        <li>ç‚¹å‡»<strong>å¼€å§‹æ¸¸æˆ</strong>æŒ‰é’®ï¼Œå…è®¸æ‘„åƒå¤´è®¿é—®</li>
                        <li>å¯¹ç€æ‘„åƒå¤´åšå‡ºä¸åŒçš„è¡¨æƒ…ï¼ŒAIä¼šè¯†åˆ«ä½ çš„æƒ…ç»ª</li>
                        <li>ç‚¹å‡»<strong>è¡¨æƒ…æŒ‘æˆ˜</strong>æŒ‰é’®å¼€å§‹æŒ‘æˆ˜æ¨¡å¼</li>
                        <li>åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­ï¼ŒæŒ‰ç…§æç¤ºåšå‡ºæŒ‡å®šè¡¨æƒ…</li>
                        <li>è¿ç»­æˆåŠŸå¯è·å¾—é¢å¤–åˆ†æ•°å¥–åŠ±</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://unpkg.com/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript">
        let modelApiUrl = 'https://teachablemachine.withgoogle.com/models/l5zlFP5FJ/'; // é»˜è®¤åœ°å€
        const URL = modelApiUrl;
        let model, webcam, labelContainer, maxPredictions;
        let isGameRunning = false;
        let animationFrameId;
        let lastEmotion = "";
        let lastTime = Date.now();
        let score = 0;
        let challengeEmotion = null;
        let challengeTimer = null;
        let challengeTimeLeft = 0;
        let consecutiveSuccess = 0;
        
        // è¡¨æƒ…ä¸å¯¹åº”çš„emojiå’Œé¢œè‰²
        const emotionEmojis = {
            "å¼€å¿ƒ": { emoji: "ğŸ˜„", color: "#10B981" },
            "ä¸å¼€å¿ƒ": { emoji: "ğŸ˜¢", color: "#6366f1" },
            "æ„¤æ€’": { emoji: "ğŸ˜ ", color: "#EF4444" },
        };
        
        // å°è‰¾çš„å¯¹è¯å†…å®¹
        const xiaoaiMessages = {
            welcome: "ä½ å¥½ï¼æˆ‘æ˜¯å°è‰¾ï¼Œæ¥å’Œæˆ‘ä¸€èµ·ç©è¡¨æƒ…æ¸¸æˆå§ï¼",
            start: "å¤ªå¥½äº†ï¼è¯·å¯¹ç€æ‘„åƒå¤´åšå‡ºå„ç§è¡¨æƒ…ï¼Œæˆ‘æ¥çŒœçŒœä½ çš„å¿ƒæƒ…~",
            challenge: "æŒ‘æˆ˜å¼€å§‹ï¼è¯·åœ¨æ—¶é—´å†…åšå‡ºæˆ‘è¦æ±‚çš„è¡¨æƒ…å“¦ï¼",
            success: "å¤ªæ£’äº†ï¼ä½ çœŸæ˜¯è¡¨æƒ…è¾¾äººï¼",
            fail: "åˆ«ç°å¿ƒï¼Œå†è¯•ä¸€æ¬¡å§ï¼",
            happy: "çœ‹åˆ°ä½ å¼€å¿ƒçš„è¡¨æƒ…ï¼Œæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒï¼",
            sad: "åˆ«ä¼¤å¿ƒï¼Œåšä¸ªé¬¼è„¸ç»™æˆ‘çœ‹çœ‹å§ï¼",
            angry: "å“‡ï¼Œä½ ç”Ÿæ°”çš„æ ·å­å¥½å“äººï¼Œä½†ä¹Ÿå¾ˆæœ‰è¶£ï¼",
            highScore: "å“‡ï¼ä½ çš„åˆ†æ•°å¤ªé«˜äº†ï¼ä½ æ˜¯è¡¨æƒ…ç‹è€…ï¼",
            stop: "æ¸¸æˆå·²åœæ­¢ï¼Œç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€é‡æ–°å¼€å§‹å§ï¼"
        };

        // æ›´æ–°å°è‰¾çš„å¯¹è¯
        function updateXiaoaiSpeech(messageKey) {
            const speechBubble = document.getElementById("xiaoai-speech");
            speechBubble.innerText = xiaoaiMessages[messageKey];
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            speechBubble.style.transform = "scale(1.1)";
            speechBubble.style.transition = "transform 0.3s ease";
            setTimeout(() => {
                speechBubble.style.transform = "scale(1)";
            }, 300);
        }

        async function init() {
            if (isGameRunning) return;
            isGameRunning = true;

            document.getElementById("start-btn").disabled = true;
            document.getElementById("stop-btn").disabled = false;
            updateXiaoaiSpeech("start");
            
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                
                // æ˜¾ç¤ºåŠ è½½è¿›åº¦
                document.getElementById("result").innerHTML = `<div style="color: var(--primary);">æ­£åœ¨åŠ è½½æ¨¡å‹...</div>`;
                
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = true;
                webcam = new tmImage.Webcam(400, 400, flip); // å¢å¤§æ‘„åƒå¤´å°ºå¯¸
                await webcam.setup();
                await webcam.play();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").appendChild(webcam.canvas);
                labelContainer = document.getElementById("label-container");
                labelContainer.innerHTML = "";
                
                document.getElementById("challenge-btn").disabled = false;
                document.getElementById("result").innerHTML = `<div style="color: var(--secondary);">å‡†å¤‡å¥½äº†ï¼åšä¸ªè¡¨æƒ…è¯•è¯•å§~</div>`;
            } catch (err) {
                alert("æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–ç”¨æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€é¡µé¢ã€‚\né”™è¯¯ä¿¡æ¯ï¼š" + err.message);
                isGameRunning = false;
                document.getElementById("start-btn").disabled = false;
                document.getElementById("stop-btn").disabled = true;
                updateXiaoaiSpeech("fail");
            }
        }

        async function loop() {
            if (!isGameRunning) return;
            webcam.update();
            await predict();
            animationFrameId = window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let maxProb = 0;
            let emotion = "";
            
            // æ¸…ç©ºæ ‡ç­¾å®¹å™¨
            labelContainer.innerHTML = "";
            
            // æ›´æ–°é¢„æµ‹ç»“æœæ˜¾ç¤º
            for (let i = 0; i < maxPredictions; i++) {
                const probability = prediction[i].probability;
                const percentage = (probability * 100).toFixed(1);
                const emotionName = prediction[i].className;
                
                // åˆ›å»ºæƒ…ç»ªæ¡
                const emotionBar = document.createElement("div");
                emotionBar.className = "emotion-bar";
                
                // è®¾ç½®æƒ…ç»ªæ¡çš„é¢œè‰²
                let barColor = "var(--primary)";
                if (emotionEmojis[emotionName]) {
                    barColor = emotionEmojis[emotionName].color;
                }
                
                // æ„å»ºæƒ…ç»ªæ¡HTML
                emotionBar.innerHTML = `
                    <div class="emotion-name">${emotionName}</div>
                    <div class="emotion-progress">
                        <div class="emotion-progress-fill" style="width: ${percentage}%; background-color: ${barColor};"></div>
                    </div>
                    <div class="emotion-percentage">${percentage}%</div>
                `;
                
                labelContainer.appendChild(emotionBar);
                
                if (probability > maxProb) {
                    maxProb = probability;
                    emotion = emotionName;
                }
            }
            
            // æŒ‘æˆ˜æ¨¡å¼é€»è¾‘
            if (challengeEmotion) {
                // æ›´æ–°æŒ‘æˆ˜è®¡æ—¶å™¨è¿›åº¦æ¡
                const progressPercentage = (challengeTimeLeft / 10) * 100;
                document.getElementById("progress-bar").style.width = `${progressPercentage}%`;
                
                if (emotion === challengeEmotion && maxProb > 0.65) { // é™ä½éš¾åº¦ï¼Œæé«˜æˆåŠŸç‡
                    document.getElementById("challenge").innerHTML = `<div class="success-message">å¤ªæ£’äº†ï¼ä½ æˆåŠŸåšå‡ºäº†ã€${challengeEmotion}ã€‘çš„è¡¨æƒ…ï¼</div>`;
                    score += 10;
                    consecutiveSuccess++;
                    
                    // è¿ç»­æˆåŠŸå¥–åŠ±
                    if (consecutiveSuccess >= 3) {
                        score += 5;
                        showBonusToast("è¿ç»­æˆåŠŸ +5 åˆ†ï¼");
                    }
                    
                    document.getElementById("score").innerText = "åˆ†æ•°: " + score;
                    
                    // æ ¹æ®åˆ†æ•°æ›´æ–°å°è‰¾çš„ååº”
                    if (score > 50) {
                        updateXiaoaiSpeech("highScore");
                    } else {
                        updateXiaoaiSpeech("success");
                    }
                    
                    // æ¸…é™¤å½“å‰æŒ‘æˆ˜è®¡æ—¶å™¨
                    if (challengeTimer) {
                        clearInterval(challengeTimer);
                    }
                    
                    // çŸ­æš‚å»¶è¿Ÿåå¼€å§‹æ–°æŒ‘æˆ˜
                    setTimeout(() => {
                        startChallenge();
                    }, 1500);
                }
            } else {
                // å¸¸è§„æ¨¡å¼ï¼šæ›´æµç•…åœ°æ˜¾ç¤ºæƒ…ç»ª
                if (emotion !== lastEmotion || Date.now() - lastTime > 800) { // å‡å°‘æ›´æ–°é—´éš”ï¼Œæé«˜å“åº”é€Ÿåº¦
                    // è·å–æƒ…ç»ªå¯¹åº”çš„é¢œè‰²
                    let emotionColor = "var(--primary)";
                    if (emotionEmojis[emotion]) {
                        emotionColor = emotionEmojis[emotion].color;
                    }
                    
                    document.getElementById("result").innerHTML = `<div style="color: ${emotionColor};">AIè¯†åˆ«ä½ ç°åœ¨çš„æƒ…ç»ªæ˜¯ï¼š${emotion}</div>`;
                    lastEmotion = emotion;
                    lastTime = Date.now();
                    
                    if (emotionEmojis[emotion]) {
                        document.getElementById("emoji").innerText = emotionEmojis[emotion].emoji;
                        
                        // æ ¹æ®æƒ…ç»ªæ›´æ–°å°è‰¾çš„ååº”
                        if (emotion === "å¼€å¿ƒ") {
                            updateXiaoaiSpeech("happy");
                        } else if (emotion === "ä¸å¼€å¿ƒ") {
                            updateXiaoaiSpeech("sad");
                        } else if (emotion === "æ„¤æ€’") {
                            updateXiaoaiSpeech("angry");
                        }
                    }
                }
            }
        }

        

                function showBonusToast(message) {
            const toast = document.getElementById('bonus-toast');
            toast.textContent = message;
            toast.style.top = '20px';
            toast.style.opacity = 1;

            setTimeout(() => {
                toast.style.opacity = 0;
                toast.style.top = '0px';
            }, 2000); // 2ç§’åæ¶ˆå¤±
        }

        function stopGame() {
            if (!isGameRunning) return;
            isGameRunning = false;

            if (webcam) {
                webcam.stop();
            }
            if (animationFrameId) {
                window.cancelAnimationFrame(animationFrameId);
            }
            if (challengeTimer) {
                clearInterval(challengeTimer);
            }

            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('challenge-btn').disabled = true;

            // Reset variables
            score = 0;
            challengeEmotion = null;
            consecutiveSuccess = 0;

            // Clear UI
            const webcamContainer = document.getElementById('webcam-container');
            if (webcamContainer) webcamContainer.innerHTML = '';
            const labelContainer = document.getElementById("label-container");
            if(labelContainer) labelContainer.innerHTML = "";
            document.getElementById('result').innerHTML = '';
            document.getElementById('emoji').innerText = '';
            document.getElementById('score').innerText = 'åˆ†æ•°: 0';
            document.getElementById('challenge').innerText = '';
            document.getElementById('progress-bar').style.width = '0%';
            
            updateXiaoaiSpeech("stop");
        }

        function startChallenge() {
            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (challengeTimer) {
                clearInterval(challengeTimer);
            }
            
            const emotions = Object.keys(emotionEmojis);
            challengeEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            
            // è·å–æƒ…ç»ªå¯¹åº”çš„é¢œè‰²
            let emotionColor = emotionEmojis[challengeEmotion].color;
            
            document.getElementById("challenge").innerHTML = `
                  <div style="font-size: 1.2rem; font-weight: bold; color: ${emotionColor};">
                      æŒ‘æˆ˜å¼€å§‹ï¼šè¯·åšå‡ºã€${challengeEmotion}ã€‘çš„è¡¨æƒ…ï¼
 
                  </div>
              `;
            document.getElementById("result").innerHTML = "";
            document.getElementById("emoji").innerText = "";
            
            // æ›´æ–°å°è‰¾çš„å¯¹è¯
            updateXiaoaiSpeech("challenge");
            
            // è®¾ç½®æŒ‘æˆ˜è®¡æ—¶å™¨ - 10ç§’
            challengeTimeLeft = 10;
            document.getElementById("progress-bar").style.width = "100%";
            
            challengeTimer = setInterval(() => {
                challengeTimeLeft--;
                
                // æ›´æ–°è¿›åº¦æ¡
                const progressPercentage = (challengeTimeLeft / 10) * 100;
                document.getElementById("progress-bar").style.width = `${progressPercentage}%`;
                
                // æ”¹å˜è¿›åº¦æ¡é¢œè‰²
                if (challengeTimeLeft <= 3) {
                    document.getElementById("progress-bar").style.background = "linear-gradient(90deg, var(--danger), var(--warning))";
                }
                
                if (challengeTimeLeft <= 0) {
                    clearInterval(challengeTimer);
                    document.getElementById("challenge").innerHTML = `<div class="fail-message">æ—¶é—´åˆ°ï¼æŒ‘æˆ˜å¤±è´¥ã€‚</div>`;
                    consecutiveSuccess = 0; // é‡ç½®è¿ç»­æˆåŠŸè®¡æ•°
                    updateXiaoaiSpeech("fail");
                    
                    // çŸ­æš‚å»¶è¿Ÿåå¼€å§‹æ–°æŒ‘æˆ˜
                    setTimeout(() => {
                        startChallenge();
                    }, 2000);
                }
            }, 1000);
        }

        // Settings Modal Logic
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeBtn = document.querySelector('.close-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const apiUrlInput = document.getElementById('api-url-input');

        // Load saved API URL on page load
        const savedApiUrl = localStorage.getItem('modelApiUrl');
        if (savedApiUrl) {
            modelApiUrl = savedApiUrl;
            apiUrlInput.value = savedApiUrl;
        } else {
            apiUrlInput.value = modelApiUrl; // Show default URL in placeholder
        }

        settingsBtn.onclick = function() {
            settingsModal.style.display = 'block';
        }

        closeBtn.onclick = function() {
            settingsModal.style.display = 'none';
        }

        saveSettingsBtn.onclick = function() {
            const newUrl = apiUrlInput.value.trim();
            if (newUrl) {
                modelApiUrl = newUrl;
                localStorage.setItem('modelApiUrl', newUrl);
                alert('API åœ°å€å·²ä¿å­˜ï¼è¯·é‡æ–°å¼€å§‹æ¸¸æˆä»¥åŠ è½½æ–°æ¨¡å‹ã€‚');
                settingsModal.style.display = 'none';
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API åœ°å€ã€‚');
            }
        }

        window.onclick = function(event) {
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>