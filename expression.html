<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>Ë°®ÊÉÖËØÜÂà´ÊÉÖÁª™Â∞èÊ∏∏Êàè</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5a6f6;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #111827;
            --dark-blue: #1E293B;
            --light: #F3F4F6;
            --gray: #6B7280;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            overflow: hidden; /* Prevent page scroll */
        }

        body { 
            background: linear-gradient(135deg, var(--dark-blue), var(--dark)); 
            color: var(--light); 
        }
        
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 0 2vw 1vh 2vw; /* Removed top padding */
        }
        
        header {
            text-align: center;
            flex-shrink: 0;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('images/station1.png') center/cover no-repeat;
            opacity: 0.1;
            z-index: -1;
        }
        
        h1 { 
            font-size: 1.4rem; /* Reduced font size */
            font-weight: 700;
            color: var(--primary); 
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 0.8rem;
            color: var(--light);
            margin: 0 0 5px 0; /* Removed top margin */
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--light);
            cursor: pointer;
            padding: 5px;
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .icon-btn:hover {
            color: var(--primary);
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }

        .modal-content {
            background-color: var(--dark-blue);
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid var(--primary);
            border-radius: 15px;
            width: 80%; 
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .close-btn {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--light);
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-light);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--gray);
            background-color: var(--dark);
            color: var(--light);
            font-size: 1rem;
        }
        
        .container {
            display: flex;
            flex: 1;
            gap: 2vw;
            padding: 0 1.5vw 1.5vh 1.5vw; /* Removed top padding */
            min-height: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px; /* Further reduced margin */
        }
        
        button { 
            background: var(--primary); 
            color: var(--light); 
            border: none; 
            border-radius: 10px; 
            padding: 8px 16px; 
            font-size: 1rem; 
            font-weight: 600;
            cursor: pointer; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover { 
            background: var(--primary-dark); 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); 
        }
        
        button:disabled { 
            background: var(--primary-light); 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        #start-btn::before {
            content: '‚ñ∂';
        }
        
        #challenge-btn::before {
            content: 'üèÜ';
        }

        #stop-btn {
            background: var(--danger);
        }

        #stop-btn:hover {
            background: #B91C1C;
        }

        #stop-btn::before {
            content: '‚èπ';
        }
        
        .left-column {
            flex: 1; /* Equal width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align to top */
            min-width: 0;
        }

        .right-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1vh; /* Tighter gap */
            min-width: 0;
            min-height: 0; /* Crucial for flex shrinking */
        }



        .info-panel {
            flex: 1; /* Grow to fill available space */
            min-height: 0; /* Allow shrinking */
            overflow-y: auto;
            background: rgba(17, 24, 39, 0.7);
            border-radius: 15px;
            padding: 1vh 1.2vw; /* Tighter padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .xiaoai-section {
            flex: 0 0 auto; /* Don't grow, don't shrink, base on content */
            background: rgba(17, 24, 39, 0.7);
            border-radius: 15px;
            padding: 0.5vh 1.2vw; /* Tighter padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .game-instructions {
            flex: 0 0 auto; /* Don't grow, don't shrink, base on content */
            overflow-y: auto;
            background: rgba(17, 24, 39, 0.7);
            border-radius: 15px;
            padding: 1vh 1.2vw; /* Tighter padding */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .game-instructions h4 {
            margin-bottom: 5px;
        }

        .game-instructions p {
            margin-bottom: 5px;
        }
        

        
        #webcam-container {
            width: 100%;
            aspect-ratio: 4 / 3; /* More common aspect ratio */
            max-height: 75vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 3px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            background: rgba(17, 24, 39, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #webcam-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #webcam-container:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.5);
        }
        
        

        .emotion-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 3px; /* More compact margin */
            padding: 8px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
        }

        .emotion-name {
            width: 80px;
            font-weight: 500;
        }

        .emotion-progress {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .emotion-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .emotion-percentage {
            width: 60px;
            text-align: right;
            font-size: 0.9rem;
            color: var(--light);
        }

        #result {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: 500;
        }

        #emoji {
            font-size: 2rem;
            text-align: center;
            margin: 10px 0;
        }

        #score {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            margin: 10px 0;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        #challenge {
            margin-top: 10px;
            text-align: center;
        }

        .bonus-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        
        #label-container { 
            font-size: 1rem; 
            margin-bottom: 5px; /* More compact margin */
        }
        
        .emotion-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .emotion-name {
            width: 80px;
            text-align: left;
            font-weight: 500;
        }
        
        .emotion-progress {
            flex-grow: 1;
            height: 10px;
            background: rgba(107, 114, 128, 0.3);
            border-radius: 5px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .emotion-progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .emotion-percentage {
            width: 60px;
            text-align: right;
            font-weight: 600;
        }
        
        #result { 
            font-size: 1.2rem; 
            font-weight: bold; 
            margin: 1px 0; /* More compact margin */
            color: var(--primary); 
            min-height: 28px;
            line-height: 1.2;
        }
        
        #emoji { 
            font-size: 3rem; 
            margin: 1px 0; /* More compact margin */
            min-height: 40px; /* Compact height */
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #score { 
            font-size: 1.1rem; 
            font-weight: 600;
            color: var(--secondary);
            margin: 1px 0; /* More compact margin */
            line-height: 1.2;
        }
        
        .progress-container { 
            width: 100%; 
            background-color: rgba(107, 114, 128, 0.3); 
            border-radius: 6px; 
            margin: 3px 0; /* More compact margin */
            overflow: hidden;
        }
        
        .progress-bar { 
            height: 8px; 
            border-radius: 6px; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            transition: width 0.3s ease; 
        }
        
        #challenge { 
            font-size: 1.2rem; 
            margin: 1px 0; /* More compact margin */
            min-height: 28px;
            line-height: 1.2;
        }
        

        
        .xiaoai-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .xiaoai-image { 
            width: 80px;
            height: 80px;
            border-radius: 15px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }
        
        .xiaoai-image:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.5);
        }
        
        .speech-bubble { 
            background: white; 
            color: var(--dark); 
            padding: 10px 12px; 
            border-radius: 15px; 
            width: 90%;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }
        
        .speech-bubble:after { 
            content: ''; 
            position: absolute; 
            bottom: -15px; 
            left: 50%; 
            border-width: 15px 15px 0; 
            border-style: solid; 
            border-color: white transparent; 
        }
        
        .game-instructions h3 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .game-instructions ul {
            padding-left: 15px;
        }
        
        .game-instructions li {
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        
        .success-message {
            color: var(--secondary);
            font-weight: 600;
        }
        
        .fail-message {
            color: var(--danger);
            font-weight: 600;
        }
        
        .bonus-message {
            color: var(--warning);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header>
            <h1 style="font-size: 1.4rem; margin: 0;">Ë°®ÊÉÖËØÜÂà´ÊÉÖÁª™Â∞èÊ∏∏Êàè</h1>
            <p class="subtitle" style="font-size: 0.8rem; margin: 2px 0 5px 0;">ÂØπÁùÄÊëÑÂÉèÂ§¥ÂÅöÂá∫Ë°®ÊÉÖÔºåÁúãÁúãAIËÉΩ‰∏çËÉΩÁåúÂá∫‰Ω†ÁöÑÊÉÖÁª™ÔºÅ</p>
            
            <div class="button-group">
                <button type="button" onclick="init()" id="start-btn">ÂºÄÂßãÊ∏∏Êàè</button>
                <button type="button" onclick="stopGame()" id="stop-btn" disabled>ÂÅúÊ≠¢Ê∏∏Êàè</button>
                <button type="button" onclick="startChallenge()" id="challenge-btn" disabled>Ë°®ÊÉÖÊåëÊàò</button>
                <button type="button" id="settings-btn">‚öôÔ∏è</button>
            </div>
        </header>

        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2>ËÆæÁΩÆ</h2>
                <div class="form-group">
                    <label for="api-url-input">AI Ê®°Âûã API Âú∞ÂùÄ:</label>
                    <input type="text" id="api-url-input" placeholder="https://teachablemachine.withgoogle.com/models/your-model/">
                </div>
                <button id="save-settings-btn">‰øùÂ≠ò</button>
            </div>
        </div>
        
        <div class="container">
            <div class="left-column">
                <div id="webcam-container"></div>
            </div>
            <div class="right-column">
                <div class="info-panel">
                    <div id="result"></div>
                    <div id="label-container"></div>
                    <div id="emoji"></div>
                    <div id="score">ÂàÜÊï∞: 0</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="challenge"></div>
                     <div id="bonus-toast" class="bonus-toast"></div>
                </div>
                <div class="xiaoai-section">
                    <div class="xiaoai-container">
                        <img src="images/xiaoai.png" alt="Â∞èËâæ" class="xiaoai-image" style="width: 100px; height: 100px;">
                        <div class="speech-bubble" id="xiaoai-speech">‰Ω†Â•ΩÔºÅÊàëÊòØÂ∞èËâæÔºåÊù•ÂíåÊàë‰∏ÄËµ∑Áé©Ë°®ÊÉÖÊ∏∏ÊàèÂêßÔºÅ</div>
                    </div>
                </div>
                <div class="game-instructions">
                    <h3>Ê∏∏ÊàèËØ¥Êòé</h3>
                    <ul>
                        <li>ÁÇπÂáª<strong>ÂºÄÂßãÊ∏∏Êàè</strong>ÊåâÈíÆÔºåÂÖÅËÆ∏ÊëÑÂÉèÂ§¥ËÆøÈóÆ</li>
                        <li>ÂØπÁùÄÊëÑÂÉèÂ§¥ÂÅöÂá∫‰∏çÂêåÁöÑË°®ÊÉÖÔºåAI‰ºöËØÜÂà´‰Ω†ÁöÑÊÉÖÁª™</li>
                        <li>ÁÇπÂáª<strong>Ë°®ÊÉÖÊåëÊàò</strong>ÊåâÈíÆÂºÄÂßãÊåëÊàòÊ®°Âºè</li>
                        <li>Âú®ÊåëÊàòÊ®°Âºè‰∏≠ÔºåÊåâÁÖßÊèêÁ§∫ÂÅöÂá∫ÊåáÂÆöË°®ÊÉÖ</li>
                        <li>ËøûÁª≠ÊàêÂäüÂèØËé∑ÂæóÈ¢ùÂ§ñÂàÜÊï∞Â•ñÂä±</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://unpkg.com/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript">
        let modelApiUrl = 'https://teachablemachine.withgoogle.com/models/l5zlFP5FJ/'; // ÈªòËÆ§Âú∞ÂùÄ
        const URL = modelApiUrl;
        let model, webcam, labelContainer, maxPredictions;
        let isGameRunning = false;
        let animationFrameId;
        let lastEmotion = "";
        let lastTime = Date.now();
        let score = 0;
        let challengeEmotion = null;
        let challengeTimer = null;
        let challengeTimeLeft = 0;
        let consecutiveSuccess = 0;
        
        // Ë°®ÊÉÖ‰∏éÂØπÂ∫îÁöÑemojiÂíåÈ¢úËâ≤
        const emotionEmojis = {
            "ÂºÄÂøÉ": { emoji: "üòÑ", color: "#10B981" },
            "‰∏çÂºÄÂøÉ": { emoji: "üò¢", color: "#6366f1" },
            "ÊÑ§ÊÄí": { emoji: "üò†", color: "#EF4444" },
        };
        
        // Â∞èËâæÁöÑÂØπËØùÂÜÖÂÆπ
        const xiaoaiMessages = {
            welcome: "‰Ω†Â•ΩÔºÅÊàëÊòØÂ∞èËâæÔºåÊù•ÂíåÊàë‰∏ÄËµ∑Áé©Ë°®ÊÉÖÊ∏∏ÊàèÂêßÔºÅ",
            start: "Â§™Â•Ω‰∫ÜÔºÅËØ∑ÂØπÁùÄÊëÑÂÉèÂ§¥ÂÅöÂá∫ÂêÑÁßçË°®ÊÉÖÔºåÊàëÊù•ÁåúÁåú‰Ω†ÁöÑÂøÉÊÉÖ~",
            challenge: "ÊåëÊàòÂºÄÂßãÔºÅËØ∑Âú®Êó∂Èó¥ÂÜÖÂÅöÂá∫ÊàëË¶ÅÊ±ÇÁöÑË°®ÊÉÖÂì¶ÔºÅ",
            success: "Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÁúüÊòØË°®ÊÉÖËææ‰∫∫ÔºÅ",
            fail: "Âà´ÁÅ∞ÂøÉÔºåÂÜçËØï‰∏ÄÊ¨°ÂêßÔºÅ",
            happy: "ÁúãÂà∞‰Ω†ÂºÄÂøÉÁöÑË°®ÊÉÖÔºåÊàë‰πüÂæàÂºÄÂøÉÔºÅ",
            sad: "Âà´‰º§ÂøÉÔºåÂÅö‰∏™È¨ºËÑ∏ÁªôÊàëÁúãÁúãÂêßÔºÅ",
            angry: "ÂìáÔºå‰Ω†ÁîüÊ∞îÁöÑÊ†∑Â≠êÂ•ΩÂêì‰∫∫Ôºå‰ΩÜ‰πüÂæàÊúâË∂£ÔºÅ",
            highScore: "ÂìáÔºÅ‰Ω†ÁöÑÂàÜÊï∞Â§™È´ò‰∫ÜÔºÅ‰Ω†ÊòØË°®ÊÉÖÁéãËÄÖÔºÅ",
            stop: "Ê∏∏ÊàèÂ∑≤ÂÅúÊ≠¢ÔºåÁÇπÂáª‚ÄúÂºÄÂßãÊ∏∏Êàè‚ÄùÈáçÊñ∞ÂºÄÂßãÂêßÔºÅ"
        };

        // Êõ¥Êñ∞Â∞èËâæÁöÑÂØπËØù
        function updateXiaoaiSpeech(messageKey) {
            const speechBubble = document.getElementById("xiaoai-speech");
            speechBubble.innerText = xiaoaiMessages[messageKey];
            
            // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
            speechBubble.style.transform = "scale(1.1)";
            speechBubble.style.transition = "transform 0.3s ease";
            setTimeout(() => {
                speechBubble.style.transform = "scale(1)";
            }, 300);
        }

        async function init() {
            if (isGameRunning) return;
            isGameRunning = true;

            document.getElementById("start-btn").disabled = true;
            document.getElementById("stop-btn").disabled = false;
            updateXiaoaiSpeech("start");
            
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                
                // ÊòæÁ§∫Âä†ËΩΩËøõÂ∫¶
                document.getElementById("result").innerHTML = `<div style="color: var(--primary);">Ê≠£Âú®Âä†ËΩΩÊ®°Âûã...</div>`;
                
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = true;
                webcam = new tmImage.Webcam(400, 400, flip); // Â¢ûÂ§ßÊëÑÂÉèÂ§¥Â∞∫ÂØ∏
                await webcam.setup();
                await webcam.play();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").appendChild(webcam.canvas);
                labelContainer = document.getElementById("label-container");
                labelContainer.innerHTML = "";
                
                document.getElementById("challenge-btn").disabled = false;
                document.getElementById("result").innerHTML = `<div style="color: var(--secondary);">ÂáÜÂ§áÂ•Ω‰∫ÜÔºÅÂÅö‰∏™Ë°®ÊÉÖËØïËØïÂêß~</div>`;
            } catch (err) {
                alert("ÊëÑÂÉèÂ§¥ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêÊàñÁî®Êú¨Âú∞ÊúçÂä°Âô®ÊâìÂºÄÈ°µÈù¢„ÄÇ\nÈîôËØØ‰ø°ÊÅØÔºö" + err.message);
                isGameRunning = false;
                document.getElementById("start-btn").disabled = false;
                document.getElementById("stop-btn").disabled = true;
                updateXiaoaiSpeech("fail");
            }
        }

        async function loop() {
            if (!isGameRunning) return;
            webcam.update();
            await predict();
            animationFrameId = window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let maxProb = 0;
            let emotion = "";
            
            // Ê∏ÖÁ©∫Ê†áÁ≠æÂÆπÂô®
            labelContainer.innerHTML = "";
            
            // Êõ¥Êñ∞È¢ÑÊµãÁªìÊûúÊòæÁ§∫
            for (let i = 0; i < maxPredictions; i++) {
                const probability = prediction[i].probability;
                const percentage = (probability * 100).toFixed(1);
                const emotionName = prediction[i].className;
                
                // ÂàõÂª∫ÊÉÖÁª™Êù°
                const emotionBar = document.createElement("div");
                emotionBar.className = "emotion-bar";
                
                // ËÆæÁΩÆÊÉÖÁª™Êù°ÁöÑÈ¢úËâ≤
                let barColor = "var(--primary)";
                if (emotionEmojis[emotionName]) {
                    barColor = emotionEmojis[emotionName].color;
                }
                
                // ÊûÑÂª∫ÊÉÖÁª™Êù°HTML
                emotionBar.innerHTML = `
                    <div class="emotion-name">${emotionName}</div>
                    <div class="emotion-progress">
                        <div class="emotion-progress-fill" style="width: ${percentage}%; background-color: ${barColor};"></div>
                    </div>
                    <div class="emotion-percentage">${percentage}%</div>
                `;
                
                labelContainer.appendChild(emotionBar);
                
                if (probability > maxProb) {
                    maxProb = probability;
                    emotion = emotionName;
                }
            }
            
            // ÊåëÊàòÊ®°ÂºèÈÄªËæë
            if (challengeEmotion) {
                // Êõ¥Êñ∞ÊåëÊàòËÆ°Êó∂Âô®ËøõÂ∫¶Êù°
                const progressPercentage = (challengeTimeLeft / 10) * 100;
                document.getElementById("progress-bar").style.width = `${progressPercentage}%`;
                
                if (emotion === challengeEmotion && maxProb > 0.65) { // Èôç‰ΩéÈöæÂ∫¶ÔºåÊèêÈ´òÊàêÂäüÁéá
                    document.getElementById("challenge").innerHTML = `<div class="success-message">Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÊàêÂäüÂÅöÂá∫‰∫Ü„Äê${challengeEmotion}„ÄëÁöÑË°®ÊÉÖÔºÅ</div>`;
                    score += 10;
                    consecutiveSuccess++;
                    
                    // ËøûÁª≠ÊàêÂäüÂ•ñÂä±
                    if (consecutiveSuccess >= 3) {
                        score += 5;
                        showBonusToast("ËøûÁª≠ÊàêÂäü +5 ÂàÜÔºÅ");
                    }
                    
                    document.getElementById("score").innerText = "ÂàÜÊï∞: " + score;
                    
                    // Ê†πÊçÆÂàÜÊï∞Êõ¥Êñ∞Â∞èËâæÁöÑÂèçÂ∫î
                    if (score > 50) {
                        updateXiaoaiSpeech("highScore");
                    } else {
                        updateXiaoaiSpeech("success");
                    }
                    
                    // Ê∏ÖÈô§ÂΩìÂâçÊåëÊàòËÆ°Êó∂Âô®
                    if (challengeTimer) {
                        clearInterval(challengeTimer);
                    }
                    
                    // Áü≠ÊöÇÂª∂ËøüÂêéÂºÄÂßãÊñ∞ÊåëÊàò
                    setTimeout(() => {
                        startChallenge();
                    }, 1500);
                }
            } else {
                // Â∏∏ËßÑÊ®°ÂºèÔºöÊõ¥ÊµÅÁïÖÂú∞ÊòæÁ§∫ÊÉÖÁª™
                if (emotion !== lastEmotion || Date.now() - lastTime > 800) { // ÂáèÂ∞ëÊõ¥Êñ∞Èó¥ÈöîÔºåÊèêÈ´òÂìçÂ∫îÈÄüÂ∫¶
                    // Ëé∑ÂèñÊÉÖÁª™ÂØπÂ∫îÁöÑÈ¢úËâ≤
                    let emotionColor = "var(--primary)";
                    if (emotionEmojis[emotion]) {
                        emotionColor = emotionEmojis[emotion].color;
                    }
                    
                    document.getElementById("result").innerHTML = `<div style="color: ${emotionColor};">AIËØÜÂà´‰Ω†Áé∞Âú®ÁöÑÊÉÖÁª™ÊòØÔºö${emotion}</div>`;
                    lastEmotion = emotion;
                    lastTime = Date.now();
                    
                    if (emotionEmojis[emotion]) {
                        document.getElementById("emoji").innerText = emotionEmojis[emotion].emoji;
                        
                        // Ê†πÊçÆÊÉÖÁª™Êõ¥Êñ∞Â∞èËâæÁöÑÂèçÂ∫î
                        if (emotion === "ÂºÄÂøÉ") {
                            updateXiaoaiSpeech("happy");
                        } else if (emotion === "‰∏çÂºÄÂøÉ") {
                            updateXiaoaiSpeech("sad");
                        } else if (emotion === "ÊÑ§ÊÄí") {
                            updateXiaoaiSpeech("angry");
                        }
                    }
                }
            }
        }

        

                function showBonusToast(message) {
            const toast = document.getElementById('bonus-toast');
            toast.textContent = message;
            toast.style.top = '20px';
            toast.style.opacity = 1;

            setTimeout(() => {
                toast.style.opacity = 0;
                toast.style.top = '0px';
            }, 2000); // 2ÁßíÂêéÊ∂àÂ§±
        }

        function stopGame() {
            if (!isGameRunning) return;
            isGameRunning = false;

            if (webcam) {
                webcam.stop();
            }
            if (animationFrameId) {
                window.cancelAnimationFrame(animationFrameId);
            }
            if (challengeTimer) {
                clearInterval(challengeTimer);
            }

            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('challenge-btn').disabled = true;

            // Reset variables
            score = 0;
            challengeEmotion = null;
            consecutiveSuccess = 0;

            // Clear UI
            const webcamContainer = document.getElementById('webcam-container');
            if (webcamContainer) webcamContainer.innerHTML = '';
            const labelContainer = document.getElementById("label-container");
            if(labelContainer) labelContainer.innerHTML = "";
            document.getElementById('result').innerHTML = '';
            document.getElementById('emoji').innerText = '';
            document.getElementById('score').innerText = 'ÂàÜÊï∞: 0';
            document.getElementById('challenge').innerText = '';
            document.getElementById('progress-bar').style.width = '0%';
            
            updateXiaoaiSpeech("stop");
        }

        function startChallenge() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®
            if (challengeTimer) {
                clearInterval(challengeTimer);
            }
            
            const emotions = Object.keys(emotionEmojis);
            challengeEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            
            // Ëé∑ÂèñÊÉÖÁª™ÂØπÂ∫îÁöÑÈ¢úËâ≤
            let emotionColor = emotionEmojis[challengeEmotion].color;
            
            document.getElementById("challenge").innerHTML = `
                  <div style="font-size: 1.2rem; font-weight: bold; color: ${emotionColor};">
                      ÊåëÊàòÂºÄÂßãÔºöËØ∑ÂÅöÂá∫„Äê${challengeEmotion}„ÄëÁöÑË°®ÊÉÖÔºÅ
 
                  </div>
              `;
            document.getElementById("result").innerHTML = "";
            document.getElementById("emoji").innerText = "";
            
            // Êõ¥Êñ∞Â∞èËâæÁöÑÂØπËØù
            updateXiaoaiSpeech("challenge");
            
            // ËÆæÁΩÆÊåëÊàòËÆ°Êó∂Âô® - 10Áßí
            challengeTimeLeft = 10;
            document.getElementById("progress-bar").style.width = "100%";
            
            challengeTimer = setInterval(() => {
                challengeTimeLeft--;
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                const progressPercentage = (challengeTimeLeft / 10) * 100;
                document.getElementById("progress-bar").style.width = `${progressPercentage}%`;
                
                // ÊîπÂèòËøõÂ∫¶Êù°È¢úËâ≤
                if (challengeTimeLeft <= 3) {
                    document.getElementById("progress-bar").style.background = "linear-gradient(90deg, var(--danger), var(--warning))";
                }
                
                if (challengeTimeLeft <= 0) {
                    clearInterval(challengeTimer);
                    document.getElementById("challenge").innerHTML = `<div class="fail-message">Êó∂Èó¥Âà∞ÔºÅÊåëÊàòÂ§±Ë¥•„ÄÇ</div>`;
                    consecutiveSuccess = 0; // ÈáçÁΩÆËøûÁª≠ÊàêÂäüËÆ°Êï∞
                    updateXiaoaiSpeech("fail");
                    
                    // Áü≠ÊöÇÂª∂ËøüÂêéÂºÄÂßãÊñ∞ÊåëÊàò
                    setTimeout(() => {
                        startChallenge();
                    }, 2000);
                }
            }, 1000);
        }

        // Settings Modal Logic
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeBtn = document.querySelector('.close-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const apiUrlInput = document.getElementById('api-url-input');

        // Load saved API URL on page load
        const savedApiUrl = localStorage.getItem('modelApiUrl');
        if (savedApiUrl) {
            modelApiUrl = savedApiUrl;
            apiUrlInput.value = savedApiUrl;
        } else {
            apiUrlInput.value = modelApiUrl; // Show default URL in placeholder
        }

        settingsBtn.onclick = function() {
            settingsModal.style.display = 'block';
        }

        closeBtn.onclick = function() {
            settingsModal.style.display = 'none';
        }

        saveSettingsBtn.onclick = function() {
            const newUrl = apiUrlInput.value.trim();
            if (newUrl) {
                modelApiUrl = newUrl;
                localStorage.setItem('modelApiUrl', newUrl);
                alert('API Âú∞ÂùÄÂ∑≤‰øùÂ≠òÔºÅËØ∑ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè‰ª•Âä†ËΩΩÊñ∞Ê®°Âûã„ÄÇ');
                settingsModal.style.display = 'none';
            } else {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ API Âú∞ÂùÄ„ÄÇ');
            }
        }

        window.onclick = function(event) {
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>